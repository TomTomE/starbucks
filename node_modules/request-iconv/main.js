var request = require('request')
  , streamBuffers = require("stream-buffers")
  , Iconv = require('iconv').Iconv

module.exports.set = function(encoding){
  return function requestWithIconv(options, func) {
    var buffer = new streamBuffers.WritableStreamBuffer();
    var iconv = new Iconv(encoding, "UTF-8");
    var r = null;

    callback = function(){
      var body = iconv.convert(buffer.getContents()).toString();
      var error = arguments[0];
      var response = arguments[1];
      func(error, response, body);
    };

    request(options, callback).pipe(buffer);
  }
}
